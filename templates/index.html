<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Food Nudging</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <div class="container">
    <h1>Food Nudging App</h1>
    
    <!-- Section for Text Input -->
    <div class="section">
      <h2>Analyze Text</h2>
      <form id="textForm" onsubmit="return handleTextSubmit(event);">
        <label for="user_text">Enter Meal Description:</label><br>
        <textarea id="user_text" name="user_text" rows="4" cols="50"
          placeholder="E.g. A sandwich with white bread and mayo"></textarea><br><br>
        <button type="submit">Analyze Text</button>
      </form>
      
      <div id="textResult" class="result-box"></div>
    </div>

    <!-- Section for Image Upload -->
    <div class="section">
      <h2>Analyze Image</h2>
      <form id="imageForm" onsubmit="return handleImageSubmit(event);" enctype="multipart/form-data">
        <label for="meal_image">Upload Meal Image:</label><br>
        <input type="file" id="meal_image" name="meal_image" accept="image/*"><br><br>
        <button type="submit">Analyze Image</button>
      </form>
      
      <div id="imageResult" class="result-box"></div>
    </div>
  </div>

  <script>
    // Handle text form submission via fetch API
    async function handleTextSubmit(event) {
      event.preventDefault(); // prevent form from reloading page

      const textInput = document.getElementById("user_text").value;
      const resultDiv = document.getElementById("textResult");
      resultDiv.innerHTML = "Analyzing...";

      try {
        const response = await fetch("/analyze-text", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded"
          },
          body: `user_text=${encodeURIComponent(textInput)}`
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          resultDiv.innerHTML = "Error: " + (errorData.error || "Unknown error");
          return;
        }
        
        const data = await response.json();
        
        // Nutritional information and product details
        let outputHtml = `<strong>Detected Ingredients:</strong> ${data.detected_ingredients.join(", ")}<br/>`;
        outputHtml += `<strong>Nudges:</strong> <ul>`;
        data.nudges.forEach(suggestion => {
          let productHtml = "";
          if (suggestion.product) {
            let nutritionHtml = "";
            if (suggestion.product.nutrition) {
              nutritionHtml = "<ul>" + 
                Object.entries(suggestion.product.nutrition)
                      .map(([nutrient, value]) => `<li>${nutrient}: ${value}</li>`)
                      .join("") + 
                "</ul>";
            }
            productHtml = `<div>
                             <strong>Product:</strong> ${suggestion.product.name}<br/>
                             <img src="${suggestion.product.image}" alt="${suggestion.product.name}" style="max-width:150px;"><br/>
                             <strong>Nutritional Information:</strong> ${nutritionHtml}
                           </div>`;
          }
          outputHtml += `<li>
                           ${suggestion.suggestionText}<br/>
                           ${productHtml}
                         </li>`;
        });
        outputHtml += `</ul>`;
        
        resultDiv.innerHTML = outputHtml;
      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = "An error occurred.";
      }
      return false; // keep page from reloading! DONT REMOVE THIS LINE
    }

    // Handle image form submission via fetch API
    async function handleImageSubmit(event) {
      event.preventDefault();

      const fileInput = document.getElementById("meal_image");
      const resultDiv = document.getElementById("imageResult");
      resultDiv.innerHTML = "Analyzing...";

      const formData = new FormData();
      formData.append("meal_image", fileInput.files[0]);

      try {
        const response = await fetch("/analyze-image", {
          method: "POST",
          body: formData
        });

        if (!response.ok) {
          const errorData = await response.json();
          resultDiv.innerHTML = "Error: " + (errorData.error || "Unknown error");
          return;
        }

        // Nutritional information and product details
        const data = await response.json();
        let outputHtml = `<strong>Meal Name:</strong> ${data.meal_name}<br/>
                          <strong>Detected Ingredients:</strong> ${data.detected_ingredients.join(", ")}<br/>
                          <strong>Nudges:</strong> <ul>`;
        data.nudges.forEach(suggestion => {
          let productHtml = "";
          if (suggestion.product) {
            let nutritionHtml = "";
            if (suggestion.product.nutrition) {
              nutritionHtml = "<ul>" + 
                Object.entries(suggestion.product.nutrition)
                      .map(([nutrient, value]) => `<li>${nutrient}: ${value}</li>`)
                      .join("") +
                "</ul>";
            }
            productHtml = `<div>
                             <strong>Product:</strong> ${suggestion.product.name}<br/>
                             <img src="${suggestion.product.image}" alt="${suggestion.product.name}" style="max-width:150px;"><br/>
                             <strong>Nutritional Information:</strong> ${nutritionHtml}
                           </div>`;
          }
          outputHtml += `<li>
                           ${suggestion.suggestionText}<br/>
                           ${productHtml}
                         </li>`;
        });
        outputHtml += `</ul>`;
        resultDiv.innerHTML = outputHtml;
      } catch (err) {
        console.error(err);
        resultDiv.innerHTML = "An error occurred.";
      }
      return false;
    }
  </script>
</body>
</html>